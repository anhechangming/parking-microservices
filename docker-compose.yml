version: '3.8'

services:
  # 用户服务数据库（包含认证）
  user-db:
    image: mysql:8.4
    container_name: user-db
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: parking_user_db
      MYSQL_USER: user_user
      MYSQL_PASSWORD: user_pass
      TZ: Asia/Shanghai
    ports:
      - "3307:3306"
    volumes:
      - user-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_password"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    networks:
      - parking-network
    restart: unless-stopped

  # 停车业务服务数据库
  parking-db:
    image: mysql:8.4
    container_name: parking-db
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: parking_business_db
      MYSQL_USER: parking_user
      MYSQL_PASSWORD: parking_pass
      TZ: Asia/Shanghai
    ports:
      - "3308:3306"
    volumes:
      - parking-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_password"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    networks:
      - parking-network
    restart: unless-stopped

  # 费用服务数据库
  fee-db:
    image: mysql:8.4
    container_name: fee-db
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: parking_fee_db
      MYSQL_USER: fee_user
      MYSQL_PASSWORD: fee_pass
      TZ: Asia/Shanghai
    ports:
      - "3309:3306"
    volumes:
      - fee-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_password"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    networks:
      - parking-network
    restart: unless-stopped

  # Nacos配置中心专用数据库 (阶段7配置 - 数据持久化)
  nacos-db:
    image: mysql:8.4
    container_name: nacos-db
    environment:
      MYSQL_ROOT_PASSWORD: nacos_root_pass
      MYSQL_DATABASE: nacos_config
      MYSQL_USER: nacos
      MYSQL_PASSWORD: nacos_pass
      TZ: Asia/Shanghai
    ports:
      - "3310:3306"
    volumes:
      - nacos-db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pnacos_root_pass"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    networks:
      - parking-network
    restart: unless-stopped

  # Nacos 3.1.0 服务注册与发现中心 (阶段7配置 - MySQL持久化)
  nacos:
    image: nacos/nacos-server:v3.1.0
    container_name: parking-nacos
    environment:
      - MODE=standalone  # 单机模式
      - PREFER_HOST_MODE=hostname
      - SPRING_DATASOURCE_PLATFORM=mysql  # 使用MySQL存储
      - MYSQL_SERVICE_HOST=nacos-db
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_DB_NAME=nacos_config
      - MYSQL_SERVICE_USER=nacos
      - MYSQL_SERVICE_PASSWORD=nacos_pass
      - MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=10000&socketTimeout=30000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true
      - NACOS_AUTH_ENABLE=false  # 暂时禁用认证，方便开发调试
      - NACOS_AUTH_TOKEN=SecretKey012345678901234567890123456789012345678901234567890123456789
      - NACOS_AUTH_IDENTITY_KEY=serverIdentity
      - NACOS_AUTH_IDENTITY_VALUE=security
      - TZ=Asia/Shanghai
      - JVM_XMS=512m  # 初始内存
      - JVM_XMX=512m  # 最大内存
    ports:
      - "8080:8080"  # 控制台端口
      - "8848:8848"  # HTTP端口
      - "9848:9848"  # gRPC端口
    volumes:
      - nacos-data:/home/nacos/data  # 持久化数据
      - nacos-logs:/home/nacos/logs  # 持久化日志
    networks:
      - parking-network
    restart: unless-stopped
    depends_on:
      nacos-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # RabbitMQ 3.13 消息队列 (阶段6配置 - 异步消息通信)
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: parking-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin123
      - TZ=Asia/Shanghai
    ports:
      - "5672:5672"   # AMQP端口
      - "15672:15672" # 管理界面端口
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - parking-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # 用户服务（包含认证）- 实例1
  user-service-1:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: parking-user-service-8081
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://user-db:3306/parking_user_db?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root_password
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - TZ=Asia/Shanghai
    ports:
      - "8081:8081"
    networks:
      - parking-network
    restart: always
    depends_on:
      user-db:
        condition: service_healthy
      nacos:
        condition: service_healthy

  # 用户服务（包含认证）- 实例2（用于测试负载均衡）
  user-service-2:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: parking-user-service-8091
    environment:
      - SERVER_PORT=8091  # 覆盖默认端口
      - SPRING_DATASOURCE_URL=jdbc:mysql://user-db:3306/parking_user_db?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root_password
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - TZ=Asia/Shanghai
    ports:
      - "8091:8091"
    networks:
      - parking-network
    restart: always
    depends_on:
      user-db:
        condition: service_healthy
      nacos:
        condition: service_healthy

  # 停车业务服务 - 实例1
  parking-service-1:
    build:
      context: ./parking-service
      dockerfile: Dockerfile
    container_name: parking-parking-service-8082
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://parking-db:3306/parking_business_db?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root_password
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=admin
      - SPRING_RABBITMQ_PASSWORD=admin123
      - TZ=Asia/Shanghai
    ports:
      - "8082:8082"
    networks:
      - parking-network
    restart: always
    depends_on:
      parking-db:
        condition: service_healthy
      nacos:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  # 停车业务服务 - 实例2（用于测试负载均衡）
  parking-service-2:
    build:
      context: ./parking-service
      dockerfile: Dockerfile
    container_name: parking-parking-service-8092
    environment:
      - SERVER_PORT=8092  # 覆盖默认端口
      - SPRING_DATASOURCE_URL=jdbc:mysql://parking-db:3306/parking_business_db?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root_password
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=admin
      - SPRING_RABBITMQ_PASSWORD=admin123
      - TZ=Asia/Shanghai
    ports:
      - "8092:8092"
    networks:
      - parking-network
    restart: always
    depends_on:
      parking-db:
        condition: service_healthy
      nacos:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  # 费用服务
  fee-service:
    build:
      context: ./fee-service
      dockerfile: Dockerfile
    container_name: parking-fee-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://fee-db:3306/parking_fee_db?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root_password
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=admin
      - SPRING_RABBITMQ_PASSWORD=admin123
      - TZ=Asia/Shanghai
    ports:
      - "8083:8083"
    networks:
      - parking-network
    restart: always
    depends_on:
      fee-db:
        condition: service_healthy
      nacos:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  # API Gateway Service (Phase 4)
  gateway-service:
    build:
      context: ./gateway-service
      dockerfile: Dockerfile
    container_name: parking-gateway-service
    environment:
      - SERVER_PORT=9000  # Gateway端口（避免与Nacos控制台8080冲突）
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - JWT_SECRET=parking-management-system-jwt-secret-key-2025-microservices-project
      - TZ=Asia/Shanghai
    ports:
      - "9000:9000"  # Gateway统一入口
    networks:
      - parking-network
    restart: always
    depends_on:
      nacos:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9000/actuator/health", "||", "exit", "1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # Frontend Web Service (阶段7 - 前端页面)
  frontend-web:
    build:
      context: ./frontend-web
      dockerfile: Dockerfile
    container_name: parking-frontend-web
    ports:
      - "80:80"  # 前端页面端口
    networks:
      - parking-network
    restart: always
    depends_on:
      - gateway-service

networks:
  parking-network:
    driver: bridge

volumes:
  user-data:
    driver: local
  parking-data:
    driver: local
  fee-data:
    driver: local
  nacos-db-data:
    driver: local
  nacos-data:
    driver: local
  nacos-logs:
    driver: local
  rabbitmq-data:
    driver: local
